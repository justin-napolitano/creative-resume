---
import '@/styles/global.css';
import {
  experienceNotes,
  experienceSkills,
  resume,
  sectionMeta,
  sectionNotes,
  siteConfig,
  siteCopy,
  skillGraph,
  utilityLinks,
} from '@/config';

const header = resume.header;
type PracticePillar = { id?: string; label?: string; note?: string; icon?: string };
const summary = (resume.summary ?? []) as PracticePillar[];
const iconForPillar = (icon?: string) => {
  const iconMap: Record<string, string> = {
    stack:
      '<svg viewBox="0 0 32 32" focusable="false"><rect x="6" y="6" width="20" height="4" rx="2" fill="currentColor" /><rect x="6" y="14" width="20" height="4" rx="2" fill="currentColor" /><rect x="6" y="22" width="20" height="4" rx="2" fill="currentColor" /></svg>',
    pulse:
      '<svg viewBox="0 0 32 32" focusable="false"><polyline points="4 18 10 18 13 10 18 24 22 15 28 15" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" /></svg>',
    handoff:
      '<svg viewBox="0 0 32 32" focusable="false"><path d="M6 11h10l-3-3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" /><path d="M26 21H16l3 3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" /><circle cx="8" cy="23" r="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="24" cy="9" r="2" fill="none" stroke="currentColor" stroke-width="2" /></svg>',
    default:
      '<svg viewBox="0 0 32 32" focusable="false"><circle cx="16" cy="16" r="6" fill="none" stroke="currentColor" stroke-width="2" /></svg>',
  };

  const key = icon && iconMap[icon] ? icon : 'default';
  return iconMap[key];
};
const experiences = resume.experience ?? [];
type ExperienceEntry = (typeof experiences)[number];
const experienceSkillMap = new Map((experienceSkills ?? []).map((entry) => [entry.experienceId, entry.skills ?? []]));

const maxExperienceChips = 13;
const computeExperienceChips = (role: ExperienceEntry) => {
  const generated = experienceSkillMap.get(role.id) ?? [];
  const baseNames = generated.map((skill) => skill.name).filter(Boolean);
  const chips: string[] = [];
  baseNames.forEach((name) => {
    if (name && !chips.includes(name)) chips.push(name);
  });
  const fallback = role.technologies ?? [];
  fallback.forEach((tech) => {
    if (!tech || chips.length >= maxExperienceChips) return;
    if (!chips.includes(tech)) chips.push(tech);
  });
  if (chips.length === 0) {
    return fallback.slice(0, maxExperienceChips);
  }
  if (chips.length < maxExperienceChips) {
    const source = baseNames.length > 0 ? baseNames : fallback;
    let idx = 0;
    while (source.length > 0 && chips.length < maxExperienceChips) {
      const next = source[idx % source.length];
      if (next) chips.push(next);
      idx += 1;
      if (idx > 200) break;
    }
  }
  return chips;
};

const trimToRows = (chips: string[], rowSize: number, maxRows: number) => {
  if (rowSize <= 0 || maxRows <= 0) return [];
  const limit = Math.min(chips.length, rowSize * maxRows);
  const full = limit - (limit % rowSize);
  return full > 0 ? chips.slice(0, full) : [];
};

const formatDate = (date?: string) => {
  if (!date) return '';
  const parts = date.split(' ');
  if (parts.length === 2) {
    const [month, year] = parts;
    return `${month.slice(0, 3).toUpperCase()} ${year}`;
  }
  return date;
};
const projects = resume.projects ?? [];
const education = resume.education ?? [];
const publications = resume.publications ?? [];
const highlightCap = 5;
type SkillItem = { name?: string; level?: number; years?: number; display?: boolean };
type GraphSkill = (typeof skillGraph.skills)[number];
type GraphCluster = (typeof skillGraph.clusters)[number];

const badgeCharLimitDesktop = 22;
const badgeCharLimitMobile = 18;
const skillBadgeAliases: Record<string, string> = {
  'Infrastructure as Code': 'Infrastructure as Code',
  'Serverless Platforms': 'Serverless Platforms',
  'Algorithms and Statistics': 'Algorithms & Stats',
  'Algorithms & Stats': 'Algorithms & Stats',
};

const friendlySkillLabel = (name: string = '', limit = badgeCharLimitDesktop) => {
  if (!name) return name;
  if (skillBadgeAliases[name]) return skillBadgeAliases[name];
  if (name.length <= limit) return name;
  const words = name.split(/\s+/);
  const trimmed = [...words];
  while (trimmed.length > 1 && trimmed.join(' ').length > limit) {
    trimmed.pop();
  }
  const phrase = trimmed.join(' ');
  if (phrase.length > 0 && phrase.length <= limit) return phrase;
  return `${name.slice(0, limit - 1)}…`;
};

const labelForSkill = (skill: GraphSkill | SkillItem) => {
  const base = (skill as any).badgeLabel ?? skill.name ?? '';
  return friendlySkillLabel(base, badgeCharLimitDesktop);
};
const normalize = (value?: number) => (typeof value === 'number' && !Number.isNaN(value) ? value : Number(value ?? 0));
const tenureValue = (value?: number) => Math.min(normalize(value), highlightCap);
const sortBySeniority = <T extends { name?: string; years?: number }>(items: T[] = []) =>
  [...items].sort((a, b) => {
    const yearDiff = tenureValue(b.years) - tenureValue(a.years);
    if (yearDiff !== 0) return yearDiff;
    return (a.name ?? '').localeCompare(b.name ?? '', undefined, { sensitivity: 'base' });
  });
const badgeToneFor = (index: number) => {
  const baseLightness = 18;
  const lightnessStep = 3.5;
  const maxLightness = 68;
  const lightness = Math.min(baseLightness + index * lightnessStep, maxLightness);
  return `hsl(170deg 16% ${lightness}%)`;
};
const graphSkills: GraphSkill[] = (skillGraph?.skills ?? []) as GraphSkill[];
const graphClusters: GraphCluster[] = (skillGraph?.clusters ?? []) as GraphCluster[];
const stackOrder = summary.map((pillar) => pillar.id ?? '');

const skillsByStack = new Map<string, GraphSkill[]>();
stackOrder.forEach((id) => skillsByStack.set(id, []));
graphSkills.forEach((skill) => {
  const stackId = skill.stack ?? 'insights';
  if (!skillsByStack.has(stackId)) skillsByStack.set(stackId, []);
  skillsByStack.get(stackId)?.push(skill);
});

const capabilityStacks = summary
  .map((pillar) => {
    const rawItems = sortBySeniority([...(skillsByStack.get(pillar.id ?? '') ?? [])]);
    const items = rawItems.slice(0, highlightCap);
    return { pillar, items };
  })
  .filter((entry) => entry.items.length > 0);

const clusterSortKey = (cluster: { stack?: string; label?: string }) => {
  const stackIdx = stackOrder.indexOf(cluster.stack ?? '');
  return `${stackIdx === -1 ? 999 : stackIdx}-${cluster.label ?? ''}`;
};

const skillAreas = graphClusters
  .map((cluster) => {
    const items = sortBySeniority(graphSkills.filter((skill) => skill.cluster === cluster.id));
    return {
      id: cluster.key ?? `cluster-${cluster.id}`,
      stack: cluster.stack,
      stackLabel: cluster.stackLabel,
      label: cluster.label ?? cluster.key ?? `Cluster ${cluster.id + 1}`,
      items,
    };
  })
  .filter((area) => area.items.length > 0)
  .sort((a, b) => (clusterSortKey(a) < clusterSortKey(b) ? -1 : clusterSortKey(a) > clusterSortKey(b) ? 1 : 0));

const formatYears = (years: number = 0) => (years > highlightCap ? `${highlightCap}+ yrs` : `${years} yrs`);
const flattenedSkills = sortBySeniority(
  skillAreas.flatMap((area) =>
    area.items.map((item) => ({ ...item, area: area.label, stack: area.stack, category: area.id }))
  )
);
const topSkillLimit = 10;
const topSkillNames = new Set(
  flattenedSkills
    .map((skill) => ({
      name: skill.name ?? '',
      score: (skill.years ?? 0) * 1.2 + (skill.level ?? 0) * 0.8,
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, topSkillLimit + 14)
    .map((entry) => entry.name)
);
const footnoteFor = (id: string) => sectionNotes[id] ?? '';
const levelLabels: Record<number, string> = {
  5: 'Principal',
  4: 'Senior',
  3: 'Mid-level',
  2: 'Associate',
  1: 'Foundational',
};

const areaLabels = new Map(skillAreas.map((area) => [area.id, area.label] as const));

const sectionCode = (id: string) => sectionMeta.find((meta) => meta.id === id)?.code ?? '';
const sectionLabel = (id: string) => sectionMeta.find((meta) => meta.id === id)?.label ?? '';
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{siteConfig.siteTitle}</title>
    <meta name="description" content={siteConfig.siteDescription} />
    <link rel="canonical" href={siteConfig.siteUrl} />
    <meta property="og:title" content={siteConfig.siteTitle} />
    <meta property="og:description" content={siteConfig.siteDescription} />
    <meta property="og:url" content={siteConfig.siteUrl} />
    <meta property="og:type" content="website" />
    <meta name="theme-color" content="#0f7c66" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=2" />
  </head>
  <body data-print-masthead={`${header.name} — systems dossier`}>
    <main>
      <header class="hero">
        <div>
          <p class="hero__eyebrow">{header.location}</p>
          <h1>{header.name}</h1>
          <p class="hero__thesis">{siteConfig.heroThesis}</p>
          <div class="hero__cta" aria-label="Primary actions">
            <a class="cta primary" href={siteConfig.bookCallUrl} target="_blank" rel="noopener noreferrer">Book a call</a>
            <a class="cta secondary" href={siteConfig.pdfPath} download>Download PDF</a>
          </div>
        </div>
        <div class="hero__details" aria-label="Contact and reference links">
          <dl class="utility-block">
            <dt>Role</dt>
            <dd>{siteCopy.hero.role}</dd>
          </dl>
          <dl class="utility-block">
            <dt>Focus</dt>
            <dd>{siteCopy.hero.focus}</dd>
          </dl>
          {utilityLinks.map((link) => (
            <dl class="utility-block">
              <dt>{link.label}</dt>
              <dd><a href={link.href}>{link.value}</a></dd>
            </dl>
          ))}
        </div>
      </header>

      {capabilityStacks.length > 0 && (
        <section class="section" id="summary">
          <span class="section__code" aria-hidden="true">{sectionCode('summary')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('summary')}</h2>
            <p class="section__subtitle">{siteCopy.sections.summary.subtitle}</p>
          </div>
          <div class="capability-grid">
            {capabilityStacks.map(({ pillar, items }) => (
              <article class="capability-card">
                <div class="capability-card__head">
                  <span class="capability-card__icon" aria-hidden="true" set:html={iconForPillar(pillar.icon)}></span>
                  <p class="capability-card__label">{pillar.label}</p>
                </div>
                <ul>
                  {items.map((item) => (
                    <li>
                      <div class="skill-row">
                        <div>
                          <span class="skill-name">{labelForSkill(item)}</span>
                          {/* Level hidden for tighter layout */}
                        </div>
                        <span class="skill-years">{formatYears(item.years ?? 0)}</span>
                      </div>
                      <div class="meter meter--dots" role="img" aria-label={`${item.name} — ${item.years} years`}>
                        {Array.from({ length: highlightCap }).map((_, dotIndex) => (
                          <span class={`dot${dotIndex < Math.round(Math.min(highlightCap, item.years ?? 0)) ? ' filled' : ''}`}></span>
                        ))}
                      </div>
                    </li>
                  ))}
                </ul>
              </article>
            ))}
          </div>
        </section>
      )}

      {experiences.length > 0 && (
        <section class="section" id="experience">
          <span class="section__code" aria-hidden="true">{sectionCode('experience')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('experience')}</h2>
            <p class="section__subtitle">{siteCopy.sections.experience.subtitle}</p>
          </div>
          <div class="experience-grid">
            {experiences.map((role) => (
              <article class="experience-item">
                <div class="experience-dates">
                  <div>{role.start}</div>
                  <div>{role.end}</div>
                </div>
                <div class="experience-body">
                  <h3>{role.title}</h3>
                  <div class="meta">{role.company} • {role.location}</div>
                  {role.bullets?.length > 0 && (
                    <ul>
                      {role.bullets.map((bullet) => <li>{bullet}</li>)}
                    </ul>
                  )}
                  {(() => {
                    const baseChips = computeExperienceChips(role);
                    const desktopChips = trimToRows(baseChips, 4, 2);
                    return (
                      <>
                        {desktopChips.length > 0 && (
                          <ul class="chip-row chip-row--desktop">
                            {desktopChips.map((chip) => <li>{chip}</li>)}
                          </ul>
                        )}
                      </>
                    );
                  })()}
                  {(siteConfig.pullQuotes?.[role.title] || experienceNotes[role.title]) && (
                    <aside class="pull-quote" aria-label="Margin note">
                      {siteConfig.pullQuotes?.[role.title] ?? experienceNotes[role.title]}
                    </aside>
                  )}
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      {projects.length > 0 && (
        <section class="section section--projects section--projects--hidden" id="work" aria-hidden="true">
          <span class="section__code" aria-hidden="true">{sectionCode('work')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('work')}</h2>
            <p class="section__subtitle">{siteCopy.sections.work.subtitle}</p>
          </div>
          <div class="projects-grid">
            {projects.map((project) => (
              <article class="project-card">
                <div>
                  <h3>{project.name}</h3>
                  {project.context && <p class="context">{project.context}</p>}
                </div>
                {project.bullets?.length > 0 && (
                  <ul>
                    {project.bullets.map((bullet) => <li>{bullet}</li>)}
                  </ul>
                )}
                {project.technologies?.length > 0 && (
                  <ul class="chip-row">
                    {project.technologies.map((tech) => <li>{tech}</li>)}
                  </ul>
                )}
              </article>
            ))}
          </div>
        </section>
      )}

      {education.length > 0 && (
        <section class="section" id="education">
          <span class="section__code" aria-hidden="true">{sectionCode('education')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('education')}</h2>
          </div>
          <div class="experience-grid">
            {education.map((entry) => (
              <article class="experience-item">
                <div class="experience-dates">
                  <div>{formatDate(entry.graduation_date)}</div>
                </div>
                <div class="experience-body">
                  <h3>{entry.degree}</h3>
                  <div class="meta">{entry.institution}</div>
                  {entry.notes && <p>{entry.notes}</p>}
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      {publications.length > 0 && (
        <section class="section" id="publications">
          <span class="section__code" aria-hidden="true">{sectionCode('publications')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('publications')}</h2>
          </div>
          <ul class="publications-list">
            {publications.map((pub) => (
              <li class="publication">
                <h4>{pub.title}</h4>
                <div class="meta">{pub.venue} • {pub.year}</div>
                {pub.url && (
                  <a href={pub.url} target="_blank" rel="noopener noreferrer">Read the paper</a>
                )}
              </li>
            ))}
          </ul>
        </section>
      )}

      {flattenedSkills.length > 0 && (
        <section class="section section--skills section--skills--tail" id="skills" data-skill-view="badges">
          <span class="section__code" aria-hidden="true">{sectionCode('skills')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('skills')}</h2>
            <p class="section__subtitle">{siteCopy.sections.skills.badges.support}</p>
          </div>
          <div class="skill-stage skill-stage--badges">
            <div class="skill-badges">
              {flattenedSkills.map((item, index) => {
                const isTop = topSkillNames.has(item.name ?? '');
                const badgeClass = `badge${isTop ? '' : ' badge--mobile-hidden'}`;
                const categoryLabel = areaLabels.get(item.category ?? '') ?? '';
                return (
                  <div class={badgeClass} style={`--badge-tone:${badgeToneFor(index)}`}>
                    <div class="skill-row">
                      <div>
                        {categoryLabel && <span class="skill-area-label">{categoryLabel}</span>}
                        <span class="skill-name">{labelForSkill(item)}</span>
                        {/* Level hidden for tighter layout */}
                      </div>
                      <div class="skill-years-group">
                        <span class="skill-years">{formatYears(item.years ?? 0)}</span>
                        <div class="meter meter--dots" role="img" aria-label={`${item.name} — ${item.years} years`}>
                          {Array.from({ length: highlightCap }).map((_, dotIndex) => (
                            <span class={`dot${dotIndex < Math.round(Math.min(highlightCap, item.years ?? 0)) ? ' filled' : ''}`}></span>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </section>
      )}

      <footer>
        {header.location && <span>{header.location}</span>}
        <span>© {new Date().getFullYear()} {header.name}</span>
        {header.email && <a href={`mailto:${header.email}`}>{header.email}</a>}
        <a href={siteConfig.bookCallUrl} target="_blank" rel="noopener noreferrer">Book a call</a>
      </footer>
    </main>
    <script is:inline>
      (() => {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const hero = document.querySelector('.hero');
        if (!prefersReducedMotion && hero) {
          hero.addEventListener('pointermove', (event) => {
            const rect = hero.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width).toFixed(3);
            const y = ((event.clientY - rect.top) / rect.height).toFixed(3);
            hero.style.setProperty('--pointer-x', x);
            hero.style.setProperty('--pointer-y', y);
          });
          hero.addEventListener('pointerleave', () => {
            hero.style.removeProperty('--pointer-x');
            hero.style.removeProperty('--pointer-y');
          });
        }
      })();
    </script>
  </body>
</html>
