---
import '@/styles/global.css';
import { experienceNotes, resume, sectionMeta, sectionNotes, siteConfig, siteCopy, utilityLinks } from '@/config';

const header = resume.header;
const summary = resume.summary ?? [];
const experiences = resume.experience ?? [];
const projects = resume.projects ?? [];
const education = resume.education ?? [];
const publications = resume.publications ?? [];
const skillHighlights = resume.skill_highlights ?? [];
const skillAreas = resume.skills ?? [];
const highlightCap = 5;
const formatYears = (years: number = 0) => (years > highlightCap ? `${highlightCap}+ yrs` : `${years} yrs`);
const flattenedSkills = skillAreas.flatMap((area) =>
  (area.items ?? []).map((item) => ({ ...item, area: area.area }))
);
const footnoteFor = (id: string) => sectionNotes[id] ?? '';
const levelLabels: Record<number, string> = {
  5: 'Principal',
  4: 'Senior',
  3: 'Mid-level',
  2: 'Associate',
  1: 'Foundational',
};

const sectionCode = (id: string) => sectionMeta.find((meta) => meta.id === id)?.code ?? '';
const sectionLabel = (id: string) => sectionMeta.find((meta) => meta.id === id)?.label ?? '';
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{siteConfig.siteTitle}</title>
    <meta name="description" content={siteConfig.siteDescription} />
    <link rel="canonical" href={siteConfig.siteUrl} />
    <meta property="og:title" content={siteConfig.siteTitle} />
    <meta property="og:description" content={siteConfig.siteDescription} />
    <meta property="og:url" content={siteConfig.siteUrl} />
    <meta property="og:type" content="website" />
    <meta name="theme-color" content="#0f7c66" />
  </head>
  <body data-print-masthead={`${header.name} — systems dossier`}>
    <main>
      <header class="hero">
        <div>
          <p class="hero__eyebrow">{header.location}</p>
          <h1>{header.name}</h1>
          <p class="hero__thesis">{siteConfig.heroThesis}</p>
          <div class="hero__cta" aria-label="Primary actions">
            <a class="cta primary" href={siteConfig.bookCallUrl} target="_blank" rel="noopener noreferrer">Book a call</a>
            <a class="cta secondary" href={siteConfig.pdfPath} download>Download PDF</a>
          </div>
        </div>
        <div class="hero__details" aria-label="Contact and reference links">
          <dl class="utility-block">
            <dt>Role</dt>
            <dd>{siteCopy.hero.role}</dd>
          </dl>
          <dl class="utility-block">
            <dt>Focus</dt>
            <dd>{siteCopy.hero.focus}</dd>
          </dl>
          {utilityLinks.map((link) => (
            <dl class="utility-block">
              <dt>{link.label}</dt>
              <dd><a href={link.href}>{link.value}</a></dd>
            </dl>
          ))}
        </div>
        <div class="hero__note" role="note">{siteConfig.marginNote}</div>
      </header>

      {summary.length > 0 && (
        <section class="section" id="summary">
          <span class="section__code" aria-hidden="true">{sectionCode('summary')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('summary')}</h2>
            <p class="section__subtitle">{siteCopy.sections.summary.subtitle}</p>
          </div>
          <ul class="summary-list">
            {summary.map((item) => <li>{item}</li>)}
          </ul>
        </section>
      )}

      {experiences.length > 0 && (
        <section class="section" id="experience">
          <span class="section__code" aria-hidden="true">{sectionCode('experience')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('experience')}</h2>
            <p class="section__subtitle">{siteCopy.sections.experience.subtitle}</p>
          </div>
          <div class="experience-grid">
            {experiences.map((role) => (
              <article class="experience-item">
                <div class="experience-dates">
                  <div>{role.start}</div>
                  <div>{role.end}</div>
                </div>
                <div class="experience-body">
                  <h3>{role.title}</h3>
                  <div class="meta">{role.company} • {role.location}</div>
                  {role.bullets?.length > 0 && (
                    <ul>
                      {role.bullets.map((bullet) => <li>{bullet}</li>)}
                    </ul>
                  )}
                  {role.technologies?.length > 0 && (
                    <ul class="chip-row">
                      {role.technologies.map((tech) => <li>{tech}</li>)}
                    </ul>
                  )}
                  {(siteConfig.pullQuotes?.[role.title] || experienceNotes[role.title]) && (
                    <aside class="pull-quote" aria-label="Margin note">
                      {siteConfig.pullQuotes?.[role.title] ?? experienceNotes[role.title]}
                    </aside>
                  )}
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      {projects.length > 0 && (
        <section class="section section--projects section--projects--hidden" id="work" aria-hidden="true">
          <span class="section__code" aria-hidden="true">{sectionCode('work')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('work')}</h2>
            <p class="section__subtitle">{siteCopy.sections.work.subtitle}</p>
          </div>
          <div class="projects-grid">
            {projects.map((project) => (
              <article class="project-card">
                <div>
                  <h3>{project.name}</h3>
                  {project.context && <p class="context">{project.context}</p>}
                </div>
                {project.bullets?.length > 0 && (
                  <ul>
                    {project.bullets.map((bullet) => <li>{bullet}</li>)}
                  </ul>
                )}
                {project.technologies?.length > 0 && (
                  <ul class="chip-row">
                    {project.technologies.map((tech) => <li>{tech}</li>)}
                  </ul>
                )}
              </article>
            ))}
          </div>
        </section>
      )}

      {(skillHighlights.length > 0 || skillAreas.length > 0) && (
        <section class="section section--skills" id="skills" data-skill-view="badges">
          <span class="section__code" aria-hidden="true">{sectionCode('skills')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('skills')}</h2>
            <p class="section__subtitle">{siteCopy.sections.skills.subtitle}</p>
          </div>
          {skillHighlights.length > 0 && (
            <div class="skill-stage">
              <div class="skill-stage__header">
                <p class="skill-stage__eyebrow">{siteCopy.sections.skills.flagship.eyebrow}</p>
                <p class="skill-stage__support">{siteCopy.sections.skills.flagship.support}</p>
              </div>
              <div class="skill-highlights">
                {skillHighlights.map((group) => (
                  <article class="skill-card skill-card--dots">
                    <div class="skill-card__header">
                      <h4>{group.area}</h4>
                      <span class="skill-card__variant-label">Dot stack</span>
                    </div>
                    <ul>
                      {group.items?.map((item) => (
                        <li>
                          <div class="skill-row">
                            <div>
                              <span class="skill-name">{item.name}</span>
                              <span class="skill-level">{levelLabels[item.level ?? 0] ?? `Level ${item.level}`}</span>
                            </div>
                            <span class="skill-years">{formatYears(item.years ?? 0)}</span>
                          </div>
                          <div class="meter meter--dots" role="img" aria-label={`${item.name} — ${item.years} years`}>
                            {Array.from({ length: highlightCap }).map((_, dotIndex) => (
                              <span class={`dot${dotIndex < Math.round(Math.min(highlightCap, item.years ?? 0)) ? ' filled' : ''}`}></span>
                            ))}
                          </div>
                        </li>
                      ))}
                    </ul>
                  </article>
                ))}
              </div>
            </div>
          )}
          {skillAreas.length > 0 && (
            <div class="skill-stage skill-stage--badges">
              <div class="skill-stage__header">
                <p class="skill-stage__eyebrow">{siteCopy.sections.skills.badges.eyebrow}</p>
                <p class="skill-stage__support">{siteCopy.sections.skills.badges.support}</p>
              </div>
              <div class="skill-badges">
                {flattenedSkills.map((item) => (
                  <div class="badge">
                    <div class="skill-row">
                      <div>
                        <span class="skill-name">{item.name}</span>
                        <span class="skill-level skill-level--block">{levelLabels[item.level ?? 0] ?? `Level ${item.level}`}</span>
                      </div>
                      <div class="skill-years-group">
                        <span class="skill-years">{formatYears(item.years ?? 0)}</span>
                        <div class="meter meter--dots" role="img" aria-label={`${item.name} — ${item.years} years`}>
                          {Array.from({ length: highlightCap }).map((_, dotIndex) => (
                            <span class={`dot${dotIndex < Math.round(Math.min(highlightCap, item.years ?? 0)) ? ' filled' : ''}`}></span>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </section>
      )}

      {education.length > 0 && (
        <section class="section" id="education">
          <span class="section__code" aria-hidden="true">{sectionCode('education')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('education')}</h2>
          </div>
          <ul class="education-list">
            {education.map((entry) => (
              <li class="education-item">
                <h4>{entry.degree}</h4>
                <div class="meta">{entry.institution}</div>
                <div class="meta">{entry.graduation_date}</div>
                {entry.notes && <p>{entry.notes}</p>}
              </li>
            ))}
          </ul>
        </section>
      )}

      {publications.length > 0 && (
        <section class="section" id="publications">
          <span class="section__code" aria-hidden="true">{sectionCode('publications')}</span>
          <div class="section__header">
            <h2 class="section__title">{sectionLabel('publications')}</h2>
          </div>
          <ul class="publications-list">
            {publications.map((pub) => (
              <li class="publication">
                <h4>{pub.title}</h4>
                <div class="meta">{pub.venue} • {pub.year}</div>
                {pub.url && (
                  <a href={pub.url} target="_blank" rel="noopener noreferrer">Read the paper</a>
                )}
              </li>
            ))}
          </ul>
        </section>
      )}

      <footer>
        {header.location && <span>{header.location}</span>}
        <span>© {new Date().getFullYear()} {header.name}</span>
        {header.email && <a href={`mailto:${header.email}`}>{header.email}</a>}
        <a href={siteConfig.bookCallUrl} target="_blank" rel="noopener noreferrer">Book a call</a>
      </footer>
    </main>
    <script is:inline>
      (() => {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const hero = document.querySelector('.hero');
        if (!prefersReducedMotion && hero) {
          hero.addEventListener('pointermove', (event) => {
            const rect = hero.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width).toFixed(3);
            const y = ((event.clientY - rect.top) / rect.height).toFixed(3);
            hero.style.setProperty('--pointer-x', x);
            hero.style.setProperty('--pointer-y', y);
          });
          hero.addEventListener('pointerleave', () => {
            hero.style.removeProperty('--pointer-x');
            hero.style.removeProperty('--pointer-y');
          });
        }
      })();
    </script>
  </body>
</html>
